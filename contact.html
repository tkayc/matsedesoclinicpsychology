<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>matsedesopsychologist - Contact</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <a
      href="https://wa.me/27615868908"
      class="whatsapp-float"
      target="_blank"
      title="Chat on WhatsApp"
    >
      <img
        src="images/whatsapp-icon.png"
        title="whatsapp icons"
        alt="WhatsApp"
      />
    </a>

    <div class="page-wrapper">
      <header class="site-header">
        <div class="brand-logo">
          <img
            src="images/logo-circle.png"
            alt="Matsedeso Logo"
            class="logo-img"
          />
          <h1>Matsedeso Clinical Psychologist</h1>
        </div>

        <nav>
          <a href="index.html">ABOUT</a>
          <a href="Psychotherapy.html">PSYCHOTHERAPY</a>
          <a href="med-assessment.html">MEDICO-LEGAL ASSESSMENTS</a>
          <a href="corporate.html">CORPORATE WELLNESS</a>
          <a href="#">CONTACT</a>
        </nav>
      </header>

      <main>
        <!--contacts section-->
        <section class="contact-details">
          <div class="contact-container">
            <div class="contact-column">
              <h3>GET IN TOUCH</h3>
              <p>üìû +27 61 586 8908</p>
              <p>‚úâÔ∏è matsedeso.clinicalpsychology@gmail.com</p>
            </div>
            <div class="contact-column">
              <h3>OFFICE HOURS</h3>
              <p>üìÖ Book by Appointment</p>
            </div>
          </div>
        </section>

       <!--booking section-->
<section class="booking-section">
  <div class="booking-container">
    <div class="booking-image">
      <img src="images/logo-blur.jpg" alt="Consulting session" />
    </div>
    <div class="booking-form">
      <div style="margin-top: 20px">
        <form id="bookingForm">
          <label>First Name:</label>
          <input type="text" name="firstname" required /><br />

          <label>Last Name:</label>
          <input type="text" name="lastname" required /><br />

          <label>Email:</label>
          <input type="email" name="email" required /><br />

          <label>Phone Number:</label>
          <input type="tel" name="phone" required /><br />

          <label>Preferred Date:</label>
          <input
            id="datePicker"
            type="text"
            name="date"
            required
          /><br />

          <div id="slots"></div>
          <input type="hidden" id="timeSlot" name="timeSlot" required />

          <label>Additional Information:</label>
          <textarea name="extra"></textarea><br />

          <button type="submit" id="submitBtn">Book Appointment</button>
        </form>
      </div>
    </div>
  </div>
</section>

<style>
  button[type="submit"] {
    background: #0077cc;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.2s ease;
    margin-top: 10px;
    display: inline-block;
  }

  button[type="submit"]:hover {
    background: #005fa3;
    transform: translateY(-2px);
  }

  button[type="submit"]:active {
    background: #004c82;
    transform: translateY(0);
  }

  #slots .spinner {
    border: 4px solid #f3f3f3; /* Light grey */
    border-top: 4px solid #0077cc; /* Blue */
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
    display: inline-block;
    vertical-align: middle;
    margin-left: 10px;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
/>

<script>
  // ===== Utility functions for parsing =====
  function parseTimeToMinutesJS(s) {
    if (!s && s !== 0) return null;
    s = String(s).trim();
    let m = s.match(/(\d{1,2}):(\d{2})/);
    if (m) return parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
    m = s.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)/i);
    if (m) {
      let hh = parseInt(m[1], 10),
        mm = m[2] ? parseInt(m[2], 10) : 0;
      const ap = m[3].toLowerCase();
      if (ap === "am" && hh === 12) hh = 0;
      if (ap === "pm" && hh < 12) hh += 12;
      return hh * 60 + mm;
    }
    const dt = new Date(s);
    if (!isNaN(dt)) return dt.getHours() * 60 + dt.getMinutes();
    return null;
  }

  function slotKeyFromStringJS(slotStr) {
    if (!slotStr) return null;
    slotStr = slotStr.trim(); // remove extra spaces
    const parts = slotStr.split(/[-‚Äì‚Äî]/);
    if (parts.length < 2) return null;
    const s = parseTimeToMinutesJS(parts[0].trim());
    const e = parseTimeToMinutesJS(parts[1].trim());
    if (s === null || e === null) return null;
    return s + "-" + e;
  }
</script>

<script> 
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyarXZAjjbszmaIZZdF1jjW11Wajg7B8JYx9eNNxattBVcsa8o65SBYtck30MHBWJKf/exec";

  const availability = {
    monday: [{ start: "17:30", end: "18:30" }],
    tuesday: [{ start: "17:30", end: "18:30" }],
    wednesday: [{ start: "16:15", end: "18:00" }],
    thursday: [{ start: "16:15", end: "18:00" }],
    friday: [{ start: "16:15", end: "18:00" }],
    saturday: [{ start: "09:00", end: "15:00" }],
    sunday: [{ start: "15:00", end: "16:00" }],
  };

  // Generate 1-hour slots
  function generateSlots(ranges) {
    let slots = [];
    ranges.forEach((range) => {
      let [sh, sm] = range.start.split(":").map(Number);
      let [eh, em] = range.end.split(":").map(Number);

      let start = new Date(0, 0, 0, sh, sm);
      let end = new Date(0, 0, 0, eh, em);

      while (start < end) {
        let slotStart = new Date(start);
        let slotEnd = new Date(start);
        slotEnd.setHours(slotEnd.getHours() + 1);
        if (slotEnd > end) slotEnd = end;

        slots.push(formatTime(slotStart) + " - " + formatTime(slotEnd));
        start = slotEnd;
      }
    });
    return slots;
  }

  function formatTime(date) {
    return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  }

  function parseTimeToMinutesJS(s) {
    if (!s && s !== 0) return null;
    s = String(s).trim();
    let m = s.match(/(\d{1,2}):(\d{2})/);
    if (m) return parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
    m = s.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)/i);
    if (m) {
      let hh = parseInt(m[1], 10),
        mm = m[2] ? parseInt(m[2], 10) : 0;
      const ap = m[3].toLowerCase();
      if (ap === "am" && hh === 12) hh = 0;
      if (ap === "pm" && hh < 12) hh += 12;
      return hh * 60 + mm;
    }
    const dt = new Date(s);
    if (!isNaN(dt)) return dt.getHours() * 60 + dt.getMinutes();
    return null;
  }

  function slotKeyFromStringJS(slotStr) {
    if (!slotStr) return null;
    const parts = slotStr.split(/[-‚Äì‚Äî]/);
    if (parts.length < 2) return null;
    const s = parseTimeToMinutesJS(parts[0].trim());
    const e = parseTimeToMinutesJS(parts[1].trim());
    if (s === null || e === null) return null;
    return s + "-" + e;
  }

  flatpickr("#datePicker", {
    dateFormat: "Y-m-d",
    minDate: "today",
    onChange: function (selectedDates, dateStr) {
      const day = selectedDates[0]
        .toLocaleDateString("en-US", { weekday: "long" })
        .toLowerCase();

      const slots = generateSlots(availability[day] || []);
      const container = document.getElementById("slots");
      container.innerHTML = "<p>Loading available slots<span class='spinner'></span></p>";

      fetch(`${SCRIPT_URL}?date=${dateStr}`)
        .then((res) => res.json())
        .then((data) => {
          const bookedKeys = data.bookedKeys || [];
          const slotStatus = {};

          slots.forEach((slot) => {
            const key = slotKeyFromStringJS(slot);

            // Treat parsing failures as booked
            if (!key) {
              slotStatus[slot] = "booked";
              return;
            }

            // Compare numeric start/end values
            const isBooked = bookedKeys.some(bk => {
              const [bkStart, bkEnd] = bk.split("-").map(Number);
              const [kStart, kEnd] = key.split("-").map(Number);
              return bkStart === kStart && bkEnd === kEnd;
            });

            slotStatus[slot] = isBooked ? "booked" : "available";
          });

          renderSlots(slotStatus);
        })
        .catch(() => {
          const slotStatus = {};
          slots.forEach((slot) => (slotStatus[slot] = "available"));
          renderSlots(slotStatus);
        });
    },
  });

  function renderSlots(slots) {
    const container = document.getElementById("slots");
    container.innerHTML = "<p>Select a time slot:</p>";

    for (const [time, status] of Object.entries(slots)) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = time;
      btn.disabled = status === "booked";
      btn.style.background = status === "available" ? "green" : "lightgrey";
      btn.style.color = "white";
      btn.style.margin = "5px";
      btn.style.padding = "10px";
      btn.style.borderRadius = "8px";
      btn.style.cursor = status === "available" ? "pointer" : "not-allowed";

      if (status === "available") {
        btn.onclick = () => {
          document.getElementById("timeSlot").value = time;
          highlightSelected(btn);
        };
      }

      container.appendChild(btn);
    }
  }

  function highlightSelected(selectedBtn) {
    document.querySelectorAll("#slots button").forEach((btn) => {
      if (!btn.disabled) btn.style.background = "green";
    });
    selectedBtn.style.background = "darkblue";
  }

  document.getElementById("bookingForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch(SCRIPT_URL, { method: "POST", body: formData })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          alert("Booking confirmed!");
          this.reset();
          document.getElementById("slots").innerHTML = "";
        } else {
          alert("Error: " + data.message);
        }
      })
      .catch((err) => alert("Error: " + err));
  });
</script>

<!--end booking section-->

      </main>

      <!--start footer section-->
      <footer class="footer-multi">
        <div class="footer-container">
          <div class="footer-column">
            <h4>NAVIGATE</h4>
            <ul>
              <li><a href="index.html">About</a></li>
              <li><a href="#">Contact</a></li>
              <li><a href="Psychotherapy.html">Psychotherapy</a></li>
              <li><a href="corporate.html">Corporate Wellness</a></li>
              <li>
                <a href="med-assessment.html">Medico-Legal Assessments</a>
              </li>
            </ul>
          </div>
          <div class="footer-column">
            <h4>SERVICES</h4>
            <ul>
              <li>Relationships</li>
              <li>Mental Health</li>
              <li>Personal Growth</li>
              <li>Life Transitions</li>
            </ul>
          </div>
          <div class="footer-column">
            <h4>CONTACT</h4>
            <p>üìû +27 61 586 8908</p>
            <p>‚úâÔ∏è matsedeso.clinicalpsychology@gmail.com</p>
            <div class="footer-socials">
              <!--<a href="#"><i class="fab fa-facebook"></i></a> -->
              <a href="https://www.instagram.com/matsedesoclinical/"
                ><i class="fab fa-instagram"></i
              ></a>
              <!--<a href="#"><i class="fab fa-whatsapp"></i></a> -->
              <a
                href="https://www.linkedin.com/in/matsedeso-nthako-makovi-a3014241?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app"
                ><i class="fab fa-linkedin"></i
              ></a>
            </div>
          </div>
        </div>
        <p style="text-align: center; margin-top: 20px">
          &copy; 2025 Matsedeso Clinical Psychologist. All rights reserved.<br />
          Website developed by <span style="font-weight: bold">Nexora</span>
        </p>
      </footer>
      <!--end footer section-->
    </div>
  </body>
</html>
